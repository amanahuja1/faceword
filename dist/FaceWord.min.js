/*! FaceWord - v0.0.2 - 2015-08-02
* Copyright (c) 2015 Rama Dimasatria; Licensed  */
FaceWord=function(){"use strict";function a(a,b,c,d){var f;return f=new Promise(function(f,g){window.setTimeout(function(){try{e(a,b,c,d),i()}catch(h){g(h.message)}f()},1)})}function b(){return q}function c(){q.clearRect(0,0,o.width,o.height)}function d(){return r}function e(a,b,c,d){for(var e in d)d.hasOwnProperty(e)&&(r[e]=d[e]);n=f(a),p=g(b),o=h(c),q=o.getContext("2d"),FaceWord.ImageProcessor.init(),FaceWord.BlockManager.init(),FaceWord.WordManager.init(b)}function f(a){var b=new Image;if(!(a instanceof HTMLImageElement&&a.src))throw new Error("Invalid image");return b.src=a.src,b.width=Math.min(a.width,r.maxImageSize),b.height=Math.min(a.height,r.maxImageSize),b}function g(a){if(!a||"string"!=typeof a)throw new Error("Invalid text");return a}function h(a){var b=document.querySelector(a);if(!(b&&b instanceof HTMLCanvasElement))throw new Error("Invalid canvas selector");return b.width=n.width,b.height=n.height,b}function i(){var a,b,d,e,f;a=FaceWord.ImageProcessor.process(n),b=FaceWord.ImageProcessor.encode(a),c();for(var g=1;g<b.valueMap.length;g++)for(d=FaceWord.BlockManager.weighMatrix(b.data,g),f=!0;f;)e=FaceWord.BlockManager.getBlock(d),e?(j(e),FaceWord.BlockManager.normalize(d,e)):f=!1}function j(a){var b,c,d,e=k(a),f=FaceWord.WordManager.getWord(),g=e.x,h=e.y,i=e.width,j=e.height,n=l(f,i,j);n&&(b=n[0],c=n[1],d=Math.ceil(.8*b),q.font=b+"px "+r.fontFamily,q.textBaseline="hanging",q.fillText(f,g,h,i),m(a,c,d))}function k(a){var b=r.blockSize;return{x:a.x*b,y:a.y*b,width:a.width*b,height:a.height*b}}function l(a,b,c){var d,e,f,g=r.minFontSize;if(q.font=g+"px serif",e=q.measureText(a).width,d=b-e,0>d)return!1;for(;d>0&&c>g&&g<r.maxFontSize;)f=e,g+=1,q.font=g+"px serif",e=q.measureText(a).width,d=b-e;return[g-1,f]}function m(a,b,c){a.renderedWidth=Math.ceil(b/r.blockSize),a.renderedHeight=Math.ceil(c/r.blockSize)}var n,o,p,q,r={contrast:0,blockSize:5,minFontSize:2,maxFontSize:48,minHeight:5,minWidth:5,maxImageSize:600,blockMinWidth:3,fontFamily:"serif"};return{getCanvasContext:b,clearCanvas:c,getSettings:d,run:a}}(),FaceWord.BlockManager=function(a){function b(){g=a.getSettings()}function c(a,b){var c,d,e,f,g=a.length,h=a[0].length,i=[];for(f=0;g>f;f++)for(d=0,i[f]=[],e=h-1;e>=0;e--)c=a[f][e],c===b?d++:d=0,i[f][e]=[d];for(e=0;h>e;e++)for(d=0,f=g-1;f>=0;f--)c=a[f][e],c===b?d++:d=0,i[f][e][1]=d;return i}function d(a){var b,c,d,e,g,h,i,j=f(a),k={};if(!j)return!1;b=j.x,c=j.y,d=0,e=Math.min(j.rowWeight,Math.ceil(.5*j.colWeight)),g=j.colWeight;for(var l=0;e>l;l++){var m,n=a[c+l][b];if(h=Math.min(g,n[0]),i=l+1,m=h*i,!(m>=d)){i=l,h=g;break}d=m,g=h}return k={x:b,y:c,width:h,height:i}}function e(a,b){if(b.renderedWidth&&b.renderedHeight){var c,d,e,f,g=b.renderedHeight,h=b.renderedWidth;for(d=b.y;d<b.y+g;d++)for(c=b.x;c<b.x+h;c++)a[d][c]=[0,0];for(d=b.y;d<g+b.y;d++)for(f=0,c=b.x-1;c>=0&&(e=a[d][c],0!==e[0]||0!==e[1]);c--)f++,e[0]=f;for(c=b.x;c<h+b.x;c++)for(f=0,d=b.y-1;d>=0&&(e=a[d][c],0!==e[0]||0!==e[1]);d--)f++,e[1]=f}}function f(a){for(var b,c=0,d={},e=0;e<a.length;e++)for(var f=0;f<a[e].length;f++)b=a[e][f][0]*a[e][f][1],b>c&&(c=b,d={x:f,y:e,colWeight:a[e][f][0],rowWeight:a[e][f][1]});return 0===c?!1:d}var g;return{init:b,weighMatrix:c,getBlock:d,normalize:e}}(FaceWord||{}),FaceWord.ImageProcessor=function(a){function b(){j={},k=a.getCanvasContext(),l=a.getSettings()}function c(a){var b,c,d,f,g,h,m=l.contrast,n=259*(m+255)/(255*(259-m));e(a),b=k.getImageData(0,0,j.width,j.height),c=b.data;for(var o=0;o<c.length;o+=4)d=c[o],f=c[o+1],g=c[o+2],h=(d+f+g)/3,h=i(n*(h-128)+128),h=h>120?255:0,c[o]=h,c[o+1]=h,c[o+2]=h;return b}function d(a){var b,c=f(a),d=[],e=[];d[0]=h();for(var g=0;g<c.length;g++){e[g]=[];for(var i=0;i<c[g].length;i++){var j=d.indexOf(c[g][i]);-1===j?(d.push(c[g][i]),e[g][i]=d.length-1):e[g][i]=j}}return b={data:e,valueMap:d}}function e(a){j.el=a,j.width=a.width,j.height=a.height,k.drawImage(j.el,0,0,j.width,j.height)}function f(a){var b,c,d,e,f,h,i,k=a.data,m=[],n=l.blockSize;for(c=0;c<j.height;c+=n)for(f=c/n,m[f]=[],e=c+n-1,e>j.height&&(e=j.height-1),b=0;b<j.width;b+=n)h=b/n,d=b+n-1,d>j.width&&(d=j.width-1),i=g(k,b,c,d,e),m[f][h]=i;return m}function g(a,b,c,d,e){for(var f,g,h=0,i=0,k=c;e>k;k++)for(var l=b;d>l;l++)f=a[4*(j.width*k+l)],h+=f,i++;return g=Math.floor(h/i),g>200?255:0}function h(){return 255}function i(a){return 0>a?0:a>255?255:a}var j,k,l;return{init:b,process:c,encode:d}}(FaceWord||{}),FaceWord.WordManager=function(){function a(a){e=c(a),d=0}function b(){var a=d-e.length*Math.floor(d/e.length),b=e[a].word;return d++,b.toUpperCase()}function c(a){var b=[],c=a.match(/[A-z]+/g),d=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","don","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your","ain't","aren't","can't","could've","couldn't","didn't","doesn't","don't","hasn't","he'd","he'll","he's","how'd","how'll","how's","i'd","i'll","i'm","i've","isn't","it's","might've","mightn't","must've","mustn't","shan't","she'd","she'll","she's","should've","shouldn't","that'll","that's","there's","they'd","they'll","they're","they've","wasn't","we'd","we'll","we're","weren't","what'd","what's","when'd","when'll","when's","where'd","where'll","where's","who'd","who'll","who's","why'd","why'll","why's","won't","would've","wouldn't","you'd","you'll","you're","you've","very"];if(c.forEach(function(a){if(a=a.toLowerCase(),-1===d.indexOf(a)){for(var c=!1,e=0;e<b.length;e++)if(b[e].word===a){b[e].occurence++,c=!0;break}c||b.push({word:a,occurence:1})}}),b.sort(function(a,b){return b.occurence-a.occurence}),0===b.length)throw new Error("Cannot parse text");return b}var d,e=[];return{init:a,getWord:b}}(FaceWord||{});